# Saiyuan代码

```c
void TK_Touch()
{
	/*<UserCodeStart>*//*<SinOne-Tag><55>*/
        if(GetLowPowerScanFlag())
        {
            /*<UserCodeStart>*//*<SinOne-Tag><56>*/
            LowPower_Touchkey_Scan();
            Light_Over();
            /*<UserCodeEnd>*//*<SinOne-Tag><56>*/
        }
        /*<UserCodeEnd>*//*<SinOne-Tag><55>*/
        /*<UserCodeStart>*//*<SinOne-Tag><57>*/
        else
        {
			
            /*<UserCodeStart>*//*<SinOne-Tag><95>*/
            if(SOCAPI_TouchKeyStatus & 0x40)
            {
                /*<UserCodeStart>*//*<SinOne-Tag><96>*/
                SOCAPI_TouchKeyStatus &= 0xbf;
                /*<UserCodeEnd>*//*<SinOne-Tag><96>*/
                /*<UserCodeStart>*//*<SinOne-Tag><97>*/
                TouchKeyRestart();
                /*<UserCodeEnd>*//*<SinOne-Tag><97>*/
            }
            /*<UserCodeEnd>*//*<SinOne-Tag><95>*/
            /*<UserCodeStart>*//*<SinOne-Tag><14>*/
            if(SOCAPI_TouchKeyStatus & 0x80)
            {
                /*<UserCodeStart>*//*<SinOne-Tag><22>*/
                SOCAPI_TouchKeyStatus &= 0x7f;
                /*<UserCodeEnd>*//*<SinOne-Tag><22>*/
                /*<UserCodeStart>*//*<SinOne-Tag><18>*/
                exKeyValueFlag = TouchKeyScan();
                /*<UserCodeEnd>*//*<SinOne-Tag><18>*/
                /*<UserCodeStart>*//*<SinOne-Tag><65>*/
				
				
				
                if(exKeyValueFlag == 0)
                {
					Key_Flag=0;
                    TK_NoKeyCount ++;
                    if(TK_NoKeyCount  > 4300)
                    {
                        TK_NoKeyCount = 0;
                        TouchKey_IntoLowPowerMode();
                    }
					Light_AllLowLight();
                }
                else
                {
                    TK_NoKeyCount = 0;
                }
                /*<UserCodeEnd>*//*<SinOne-Tag><65>*/
                /*<UserCodeStart>*//*<SinOne-Tag><35>*/
                UserCode();
                /*<UserCodeEnd>*//*<SinOne-Tag><35>*/
                /*<UserCodeStart>*//*<SinOne-Tag><36>*/
                TouchKeyRestart();
                /*<UserCodeEnd>*//*<SinOne-Tag><36>*/
            }
            /*<UserCodeEnd>*//*<SinOne-Tag><14>*/
        }
        /*<UserCodeEnd>*//*<SinOne-Tag><57>*/
}
```



## main

```c
//************************************************************
//  Copyright (c)  
//	FileName	  : main.c
//	Function	  : Main Function
//  Instructions  : Contains the MCU initialization function and its H file
//************************************************************
/********************Includes************************************************************************/
#include "SC_Init.h"	// MCU initialization header file, including all firmware library header files
#include "SC_it.h"
#include "..\Drivers\SCDriver_list.h"
#include "HeadFiles\SysFunVarDefine.h"
#include "delay.h"
#include "Light.h"
#include "Key.h"
/**************************************Generated by EasyCodeCube*************************************/
int i=0;
unsigned char KeyValue=0;//用来获取数值
unsigned char Key_Flag=0; //用来判断标志位
unsigned char Key_Throw; //丢弃标志位
unsigned char Count;//用来统计次数

int Key_TimeCount;//计时判断模式
unsigned char Key_Mode=0;//输入模式

bool Key_Check;
unsigned char Key_Time;
unsigned char Key_Pos;//用来记录密码位置

unsigned char Key_In[9]={20,20,20,20,20,20,20,20,20};//用来储存密码
void Key_Get_First(void);

//模式1
unsigned char Key_Mode1[4]={1,2,3,4};//用来储存密码
void Key_Get_1(void);
//模式2
unsigned char Key_Temp;
unsigned char Key_Mode2[6]={1,2,3,6,5,4};//用来储存密码
void Key_Get_2(void);
//模式3
unsigned char Key_CheckCount;//用来检测密码正确性
unsigned char Key_Again;//两次输入密码即可
bool Admin_Mode;//是否进入管理员模式
unsigned char Key_Mode3[4]={1,1,1,4};//用来储存密码
unsigned char Key_Mode3_Temp[4]={1,1,1,4};//用来储存设置密码
void Key_Get_3(void);

void Key_Insert(void);
void Key_Che(void);

void Buzzer(void);

void WriteHigh(void);

void TK_Touch(void);

/*************************************.Generated by EasyCodeCube.************************************/
/*****************************************************************************************************
* Function Name: main
* Description  : This function implements main function.
* Arguments    : None
* Return Value : None
******************************************************************************************************/
void main(void)
{
    /*<Generated by EasyCodeCube begin>*/
    /*<UserCodeStart>*//*<SinOne-Tag><186>*/    
    SC_Init();
    
    PWM_IndependentModeConfigEX(PWM00,0, PWM_OUTPUTSTATE_ENABLE);
	PWM_CmdEX(PWM2_Type,DISABLE);
    /*<UserCodeEnd>*//*<SinOne-Tag><186>*/
    /*<UserCodeStart>*//*<SinOne-Tag><9>*/
    TouchKeyInit();
	Light_AllLowLight();
	
    /*<UserCodeEnd>*//*<SinOne-Tag><9>*/
    /*<UserCodeStart>*//*<SinOne-Tag><10>*/
    while(1)
    {
		TK_Touch();
		
		if(Key_Mode==2 && Key_TimeCount > 500)
		{
			Key_Pos=6;	
		}
		
		switch (Key_Mode)
        {
        	case 0:
				Key_Get_First();
        		break;
        	case 1:
				Key_Get_1();
        		break;
			case 2:
				Key_Get_2();
        		break;
			case 3:
				Key_Get_3();
        		break;
        	default:
        		break;
        }
		
		

		Key_Che();
		
    }
    /*<UserCodeEnd>*//*<SinOne-Tag><10>*/
    /*<Generated by EasyCodeCube end>*/
}

void TK_Touch()
{
        if(GetLowPowerScanFlag())
        {
			Key_Throw=3;
			Key_Pos=0;
            LowPower_Touchkey_Scan();
            Light_Over();
        }
        else
        {
            if(SOCAPI_TouchKeyStatus & 0x40)
            {
                SOCAPI_TouchKeyStatus &= 0xbf;
                TouchKeyRestart();
            }
            if(SOCAPI_TouchKeyStatus & 0x80)
            {
                SOCAPI_TouchKeyStatus &= 0x7f;
                exKeyValueFlag = TouchKeyScan();
				if(exKeyValueFlag!=0)
				{
					KeyValue=Key_Transit(exKeyValueFlag);
					Key_Flag=1;
				}
				
                if(exKeyValueFlag == 0)
                {
					Key_Flag=0;
					if(Key_Mode!=1)
					{
						Key_TimeCount++;
					}
                    TK_NoKeyCount++;
                    if(TK_NoKeyCount  > 4300)
                    {
                        TK_NoKeyCount = 0;
                        TouchKey_IntoLowPowerMode();
                    }
					if(Key_Mode == 1||Key_Mode == 3)
					{
						Light_AllLowLight();
					}
					
                }
                else
                {
                    TK_NoKeyCount = 0;
                }
                UserCode();


                TouchKeyRestart();
            }
        }
}

void Key_Get_First()
{
	if(Key_Pos==0)
	{
		Key_TimeCount=0;
	}
	
	if(Key_Flag)
	{
		Count++;
		if(Count==3)
		{
			if(Key_Throw)
			{
				Key_Throw--;
				Light_AllHighLight();
				delay_ms(300);//别删！
				Light_AllLowLight();
			}
			else if(Key_Pos==0 && Key_Throw==0)
			{
				Light_Over();
				KeyValue=Key_Transit(exKeyValueFlag);
				Light_LightOne(KeyValue);
				Key_Insert();
				Key_Temp=KeyValue;
				
				Light_AllLowLight();
			}	
			else if(Key_Pos==1 && Key_Throw==0)
			{
				if(Key_TimeCount < 100 && Key_Temp!=KeyValue)
				{
					Light_Over();
					Light_LightOne(Key_In[0]);
					Key_Mode=2;
					Key_TimeCount=40;
				}
				else if(Key_TimeCount > 100)
				{
					Light_Over();
					Key_Mode=1;
					Key_TimeCount=40;
				}
			}
			Key_Flag=0;
			Count=0;
		}
		Key_Flag=0;
	}
}

void Key_Get_1()
{
	if(Key_Flag)
	{
		Count++;
		if(Count==3)
		{
			Light_Over();
			KeyValue=Key_Transit(exKeyValueFlag);
			Light_LightOne(KeyValue);
			Key_Insert();
			Key_Flag=0;
			Count=0;
		}
		Key_Flag=0;
	}
	
}

void Key_Get_2()
{
	if(Key_Flag)
	{
		Count++;
		if(Count==3)
		{
			
			KeyValue=Key_Transit(exKeyValueFlag);
			if(Key_Temp != KeyValue)
			{
				Light_LightOne(KeyValue);
				Key_Insert();
			}
			Key_Flag=0;
			Count=0;
			Key_Temp=KeyValue;
		}
		Key_Flag=0;
	}
	Key_TimeCount=0;
}

void Key_Get_3()
{
	if(Key_Flag)
	{
		Count++;
		if(Count==3)
		{
			Light_Over();
			KeyValue=Key_Transit(exKeyValueFlag);
			Light_LightOne(KeyValue);
			
			if(KeyValue==12)
			{
				Admin_Mode=0;
				Key_Again=0;
				Key_Mode=0;
				Key_Pos=0;
				Buzzer();
				delay_ms(1000);
				Buzzer();
			}
			
			if(Admin_Mode)
			{
				Key_Insert();
			}
			else if(KeyValue==10 && Admin_Mode==0)
			{
				Admin_Mode=1;
				Light_AllHighLight();
				Buzzer();
				delay_ms(800);
				Light_AllLowLight();
			}
			Key_Flag=0;
			Count=0;
		}
		Key_Flag=0;
	}
}

void Key_Insert()
{
	if(Key_Pos<9 && (Admin_Mode==0 || Admin_Mode==2))
	{
		Key_In[Key_Pos]=KeyValue;
		Key_Pos++;
		Buzzer();
		delay_ms(100);
	}
	if(Key_Pos<9 && Admin_Mode==1)
	{
		Key_Mode3_Temp[Key_Pos]=KeyValue;
		Key_Pos++;
		Buzzer();
		delay_ms(100);
	}
}

void Key_Che()
{
	if(Key_Mode==1)//密码模式以及管理员模式检查
	{
		if(Key_Pos>3)
		{
			Key_Check=1;
			for(i=0;i<4;i++)
			{
				if(Key_In[i]!=Key_Mode1[i])
				{
					Key_Check=0;
					break;
				}
			}
			for(i=0;i<4;i++)
			{
				if(Key_In[i]==Key_Mode3[i])
				{
					Key_CheckCount++;
				}
			}
			
			if(Key_CheckCount==4)
			{
				Key_Check=1;
				Key_Mode=3;
				Key_CheckCount=0;
				Light_AllHighLight();
			}
			else Key_CheckCount=0;
			
			if(Key_Check)		//密码正确
			{
				Buzzer();
				if(Key_Mode!=3) Key_Mode=0;
				Key_Time=0;
			}
			else				//密码错误
			{
				Light_Over();
				Buzzer();
				delay_ms(100);
				Light_AllHighLight();
				delay_ms(100);
				Light_Over();
				Buzzer();
				delay_ms(100);
				Light_AllHighLight();
				delay_ms(100);
				Light_Over();
				Buzzer();
				delay_ms(100);
				Light_AllHighLight();
				delay_ms(100);
				Light_Over();
				Buzzer();
				Key_Mode=0;
				Key_Time++;//次数增加
			}
			for(i=0;i<4;i++)
			{
				Key_In[i]=20;
			}
			Light_AllLowLight();
			Key_Pos=0;
		}
	}
	

	else if(Key_Mode==2)//手势识别检查
	{
		if(Key_Pos>5)
		{
			Key_Check=1;
			
			for(i=0;i<6;i++)
			{
				if(Key_In[i]!=Key_Mode2[i])
				{
					Key_Check=0;
					break;
				}
			}
				
			if(Key_Check)		//密码正确
			{
				Buzzer();
				Key_Time=0;
			}
				
			else				//密码错误
			{
				Light_Over();
				Buzzer();
				delay_ms(100);
				Light_AllHighLight();
				delay_ms(100);
				Light_Over();
				Buzzer();
				delay_ms(100);
				Light_AllHighLight();
				delay_ms(100);
				Light_Over();
				Buzzer();
				delay_ms(100);
				Light_AllHighLight();
				delay_ms(100);
				Light_Over();
				Buzzer();
					
				Key_Time++;//次数增加
			}
			for(i=0;i<6;i++)
			{
				Key_In[i]=20;
			}
			Light_AllLowLight();
			Key_Mode=0;
			Key_Pos=0;
		}
		

	}
	
	
	
	else if(Key_Mode==3)//管理员重新设置密码
	{
		if(Key_Pos>3 && Admin_Mode==1)
		{
			Key_Pos=0;
			Admin_Mode++;
			Light_AllHighLight();
			Buzzer();
			delay_ms(1000);
			Light_AllLowLight();
		}
		if(Key_Pos>3 && Admin_Mode==2)
		{
			Key_Pos=0;
			Key_Mode=0;
			for(i=0;i<4;i++)
			{
				if(Key_Mode3_Temp[i]==Key_In[i])
				{
					Key_CheckCount++;
				}
			}
			if(Key_CheckCount==4)
			{
				for(i=0;i<4;i++)
				{
					Key_Mode1[i]=Key_Mode3_Temp[i];
				}
				Light_AllHighLight();
				Buzzer();
				delay_ms(1000);
				Buzzer();
				delay_ms(1000);
				Key_CheckCount=0;
				Key_Pos=0;
				Admin_Mode=0;
				Key_Mode=0;
				Buzzer();
				delay_ms(1000);
				Light_AllLowLight();
			}
			else
			{
				Key_CheckCount=0;
				Key_Pos=0;
				Admin_Mode=0;
				Key_Mode=0;
				Buzzer();
				delay_ms(1000);
				Buzzer();
				delay_ms(1000);
				Buzzer();
				delay_ms(1000);
				
			}
		}
	}
	
	if(Key_Time==5)//检测是否输入错误次数大于五次
	{
		for(i=0;i<10;i++)
		{
			delay_ms(1000);
		}
		Key_Time=0;
	}
}

void Buzzer()
{
	PWM_CmdEX(PWM2_Type,ENABLE);
	delay_ms(50);
	PWM_CmdEX(PWM2_Type,DISABLE);
}

void WriteHigh()
{
	GPIO_WriteHigh(GPIO3, GPIO_PIN_7);
    GPIO_WriteHigh(GPIO3, GPIO_PIN_6);
    GPIO_WriteHigh(GPIO3, GPIO_PIN_5);
    GPIO_WriteHigh(GPIO3, GPIO_PIN_4);
}

```

